# seleniumhub:
#   image: selenium/hub
#   ports:
#     - 4444:4444
#   environment:
#     - no_proxy=localhost
#     - HUB_ENV_no_proxy=localhost

# firefoxnode:
#   image: selenium/node-firefox
#   ports:
#     - 5900
#   links:
#     - seleniumhub:hub

# vpn:
#   image: dperson/openvpn-client
#   # image: kylemanna/openvpn
#   container_name: vpn
#   cap_add:
#     - net_admin
#   ports:
#     - "1194:1194/udp"
#   restart: always
#   volumes:
#     - /Users/david/Desktop/zorroa-openvpn-client:/vpn # dperson style
#     # - /Users/david/Desktop/zorroa-openvpn-client:/etc/openvpn # kylemanna style
#     # - 'vpn.server.name;username;password'
#   devices:
#     - /dev/net/tun

chromenode:
  image: selenium/node-chrome
  # depends_on:
  #   # https://github.com/dperson/openvpn-client/blob/master/docker-compose.yml
  #   - openvpn
  # links:
  #   - openvpn
  #   # - seleniumhub:hub
  ports:
    - 5900:5900
    - 5555:5555
  extra_hosts:
    - "shub:10.8.0.1"
  environment:
    # TZ: 'EST5EDT'
    - NODE_MAX_INSTANCES=4
    - NODE_MAX_SESSION=4
    # - EXTERNAL_IP=10.8.0.4
    # - REMOTE_HOST=10.8.0.4 # https://groups.google.com/forum/#!searchin/selenium-users/docker|sort:relevance/selenium-users/1Cg6lUF1Cyk/O_AQHe3zBgAJ
    - SE_OPTS=-host 10.8.0.4 -port 5555
    # - SE_OPTS=-host localhost -port 5555
    - HUB_PORT_4444_TCP_ADDR=shub #10.8.0.1 #localhost
    - HUB_PORT_4444_TCP_PORT=4444
    - REGISTER=TRUE
    # // IIRC The no_proxy junk above is a mac-only issue
    # // https://github.com/SeleniumHQ/docker-selenium/issues/227#issuecomment-224865735
    # // https://github.com/SeleniumHQ/docker-selenium/issues/91#issuecomment-250502062
    - no_proxy=localhost
    - HUB_ENV_no_proxy=localhost
  # read_only: true
  # tmpfs:
  #   - /run
  #   - /tmp
  #   # - /var/cache/nginx
  # networks:
    # - container:openvpn



# hub on shub
# node on local
# ssh -L 4444:localhost:4444 -R 5900:localhost:5900 -R 8081:localhost:8081 z-shub

# machang notes
# docker run -d -p 5555:5555 -e HUB_PORT_4444_TCP_ADDR="localhost" -e HUB_PORT_4444_TCP_PORT="4444" --name chrome-node selenium/node-chrome
# docker cp ~/.ssh/id_rsa_zorroa 20485d8efd8c:/id_rsa_zorroa
# docker exec -it 20485d8efd8c sudo apt-get update
# docker exec -it 20485d8efd8c sudo apt-get -y install openssh-client
# docker cp do_tunnel.sh 20485d8efd8c:/do_tunnel.sh
# docker exec -it 20485d8efd8c sudo chmod a+rx /do_tunnel.sh
# docker exec -it 20485d8efd8c /do_tunnel.sh
#
# docker attach --sig-proxy=false 20485d8efd8c
#
# [do_tunnel.sh]
# #!/bin/bash
# ssh -i /id_rsa_zorra computeruser@shub.zorroa.com -L 4444:localhost:4444 -f -N
#

# I installed openssh-server
#   and added GatewayPorts yes; then "sudo service ssh restart"
# created an ssh key on shub & copied the key to selenium-hub container & my mac
#   cd .ssh
#   ssh-keygen
#   cat id_rsa.pub >> authorized_keys
#   docker cp id_rsa selenium-hub:/home/seluser/.ssh/
#   docker cp id_rsa.pub selenium-hub:/home/seluser/.ssh/

# opened port 32222 on shub (using the AWS panel)
# (re)start the selenium-hub docker (computeruser@shub:~$)
#   docker run -d -p 4444:4444 -p 32222:22 --name selenium-hub -P selenium/hub

# on shub.zorroa.com:
# docker run -d -p 4444:4444 --name selenium-hub -P selenium/hub
# docker exec -it selenium-hub mkdir /home/seluser/.ssh
# docker cp ~/.ssh/id_rsa selenium-hub:/home/seluser/.ssh/
# docker cp ~/.ssh/id_rsa.pub selenium-hub:/home/seluser/.ssh/
# docker cp ~/.ssh/id_rsa.pub selenium-hub:/home/seluser/.ssh/authorized_keys
# docker exec selenium-hub sudo chown seluser /home/seluser/.ssh/id_rsa
# docker exec selenium-hub sudo chown seluser /home/seluser/.ssh/id_rsa.pub
# docker exec selenium-hub sudo apt-get update
# docker exec selenium-hub sudo apt-get -y install openssh-client
# docker exec selenium-hub sudo apt-get -y install openssh-server
# docker cp selenium-hub:/etc/ssh/sshd_config .
# echo "GatewayPorts yes" >> sshd_config
# docker cp sshd_config selenium-hub:/etc/ssh/sshd_config
# docker exec selenium-hub sudo service ssh start
# docker exec ssh -fnNT -R 32222:localhost:22 computeruser@shub.zorroa.com

# # on my mac:
# scp 'computeruser@shub.zorroa.com:~/.ssh/id_rsa*' .
# ssh -fnNT -p 32222 seluser@shub.zorroa.com -i id_rsa -L 4444:localhost:4444 # now i can connect to localhost:4444 on my mac
# # dc up
# docker exec -it zorroajscurator_chromenode_1 mkdir /home/seluser/.ssh
# docker cp id_rsa zorroajscurator_chromenode_1:/home/seluser/.ssh/
# docker cp id_rsa.pub zorroajscurator_chromenode_1:/home/seluser/.ssh/
# docker cp id_rsa.pub zorroajscurator_chromenode_1:/home/seluser/.ssh/authorized_keys
# docker exec zorroajscurator_chromenode_1 sudo chown seluser /home/seluser/.ssh/id_rsa
# docker exec zorroajscurator_chromenode_1 sudo chown seluser /home/seluser/.ssh/id_rsa.pub
# docker exec zorroajscurator_chromenode_1 sudo apt-get update
# docker exec zorroajscurator_chromenode_1 sudo apt-get -y install openssh-client
# # docker exec zorroajscurator_chromenode_1 sudo apt-get -y install openssh-server
# # docker cp zorroajscurator_chromenode_1:/etc/ssh/sshd_config .
# # echo "GatewayPorts yes" >> sshd_config
# # docker cp sshd_config zorroajscurator_chromenode_1:/etc/ssh/sshd_config
# # docker exec zorroajscurator_chromenode_1 sudo service ssh start
# docker exec zorroajscurator_chromenode_1 ssh -fnNT -R 5555:localhost:5555 -L 4444:localhost:4444 -p 32222 seluser@shub.zorroa.com -i /home/seluser/.ssh/id_rsa


# ## connect & install openssh
# screen docker exec -it selenium-hub bash
# ##<detach screen: ^a d>
# ##now i can connect to localhost:4444 on my mac

# NOT NEEDED
#   seluser@[docker-id]:~$ ssh -R 32222:localhost:22 computeruser@shub.zorroa.com
#   # this forwards incoming ssh
# from my mac:
#   ssh -p 32222 seluser@shub.zorroa.com -i id_rsa -L 4444:localhost:4444


